<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', {title: title}) %>
    <link rel="stylesheet" href="/css/customer-dashboard.css">
</head>
<body class="customer-dashboard">
    <%- include('../partials/header') %>
    
    <div class="dashboard-container">
        <%- include('../partials/customer-sidebar', {
            pendingAppointmentsCount: pendingAppointmentsCount,
            currentPage: currentPage
        }) %>
        
        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>Welcome back, <%= customer.name %>!</h1>
                <p>Here's your appointment overview and statistics</p>
            </div>

            <!-- Stats Cards Partial -->
            <%- include('../partials/stats-cards', {stats: stats}) %>

            <div class="dashboard-content">
                <div class="dashboard-grid">
                    <!-- Upcoming Appointments -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>Upcoming Appointments</h2>
                            <a href="/customer/booking" class="btn btn-primary">Book New</a>
                        </div>
                        <div class="card-body">
                            <% if (upcomingAppointments.length > 0) { %>
                                <div class="appointments-list">
                                    <% upcomingAppointments.forEach(appointment => { %>
                                        <div class="appointment-item">
                                            <div class="appointment-info">
                                                <div class="service-name"><%= appointment.service.name %></div>
                                                <div class="appointment-details">
                                                    <span class="barber"><%= appointment.barber.name %></span>
                                                    <span class="date"><%= moment(appointment.appointment_date).format('MMM DD, YYYY h:mm A') %></span>
                                                </div>
                                                <span class="status-badge status-<%= appointment.status %>">
                                                    <%= appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1) %>
                                                </span>
                                            </div>
                                            <div class="appointment-actions">
                                                <button class="btn btn-sm btn-outline view-details" 
                                                        data-appointment-id="<%= appointment.id %>">
                                                    Details
                                                </button>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-calendar-plus"></i>
                                    <p>No upcoming appointments</p>
                                    <a href="/customer/booking" class="btn btn-primary">Book Your First Appointment</a>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Recent History -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>Recent History</h2>
                            <a href="/customer/appointment-history" class="btn btn-outline">View All</a>
                        </div>
                        <div class="card-body">
                            <% if (recentAppointments.length > 0) { %>
                                <div class="appointments-list">
                                    <% recentAppointments.forEach(appointment => { %>
                                        <div class="appointment-item">
                                            <div class="appointment-info">
                                                <div class="service-name"><%= appointment.service.name %></div>
                                                <div class="appointment-details">
                                                    <span class="barber"><%= appointment.barber.name %></span>
                                                    <span class="date"><%= moment(appointment.appointment_date).format('MMM DD, YYYY') %></span>
                                                    <span class="price">$<%= appointment.total_price %></span>
                                                </div>
                                                <span class="status-badge status-<%= appointment.status %>">
                                                    <%= appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1) %>
                                                </span>
                                            </div>
                                            <div class="appointment-actions">
                                                <% if (appointment.status === 'completed' && !appointment.rating) { %>
                                                    <a href="/customer/rate-service/<%= appointment.id %>" 
                                                       class="btn btn-sm btn-primary">Rate</a>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <p>No appointment history yet</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>

                <!-- Favorites Section -->
                <div class="dashboard-grid">
                    <!-- Favorite Barber -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>Favorite Barber</h2>
                        </div>
                        <div class="card-body">
                            <% if (stats.favoriteBarber) { %>
                                <div class="favorite-item">
                                    <div class="favorite-avatar">
                                        <i class="fas fa-user-cut"></i>
                                    </div>
                                    <div class="favorite-info">
                                        <h3><%= stats.favoriteBarber.name %></h3>
                                        <p><%= stats.favoriteBarber.appointmentCount %> appointments</p>
                                    </div>
                                    <a href="/customer/barbers" class="btn btn-sm btn-outline">View Profile</a>
                                </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-user-cut"></i>
                                    <p>No favorite barber yet</p>
                                    <a href="/customer/barbers" class="btn btn-primary">Explore Barbers</a>
                                </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Favorite Service -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2>Favorite Service</h2>
                        </div>
                        <div class="card-body">
                            <% if (stats.favoriteService) { %>
                                <div class="favorite-item">
                                    <div class="favorite-avatar">
                                        <i class="fas fa-scissors"></i>
                                    </div>
                                    <div class="favorite-info">
                                        <h3><%= stats.favoriteService.name %></h3>
                                        <p>Booked <%= stats.favoriteService.serviceCount %> times</p>
                                    </div>
                                    <a href="/customer/services" class="btn btn-sm btn-outline">View Service</a>
                                </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-scissors"></i>
                                    <p>No favorite service yet</p>
                                    <a href="/customer/services" class="btn btn-primary">View Services</a>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Appointment Details Modal -->
    <%- include('../partials/appointment-modal') %>

    <%- include('../partials/scripts') %>
    
    <script>
        // Appointment details modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            // View appointment details
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const appointmentId = this.getAttribute('data-appointment-id');
                    fetchAppointmentDetails(appointmentId);
                });
            });

            async function fetchAppointmentDetails(appointmentId) {
                try {
                    const response = await fetch(`/customer/appointments/${appointmentId}/details`);
                    const data = await response.json();
                    
                    if (data.success) {
                        showAppointmentModal(data.appointment);
                    } else {
                        showFlashMessage(data.error, 'error');
                    }
                } catch (error) {
                    console.error('Error fetching appointment details:', error);
                    showFlashMessage('Failed to load appointment details', 'error');
                }
            }

            function showAppointmentModal(appointment) {
                // Format appointment date
                const appointmentDate = new Date(appointment.appointment_date);
                const formattedDate = appointmentDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Populate modal content
                document.getElementById('modalServiceName').textContent = appointment.service.name;
                document.getElementById('modalBarberName').textContent = appointment.barber.name;
                document.getElementById('modalAppointmentDate').textContent = formattedDate;
                document.getElementById('modalStatus').textContent = appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1);
                document.getElementById('modalPrice').textContent = `$${appointment.total_price}`;
                document.getElementById('modalDuration').textContent = `${appointment.service.duration} minutes`;
                
                if (appointment.notes) {
                    document.getElementById('modalNotes').textContent = appointment.notes;
                    document.getElementById('modalNotes').parentElement.style.display = 'block';
                } else {
                    document.getElementById('modalNotes').parentElement.style.display = 'none';
                }

                // Update status badge class
                const statusBadge = document.getElementById('modalStatus');
                statusBadge.className = `status-badge status-${appointment.status}`;

                // Show cancel button only for pending/confirmed appointments
                const cancelBtn = document.getElementById('cancelAppointmentBtn');
                if (['pending', 'confirmed'].includes(appointment.status)) {
                    cancelBtn.style.display = 'block';
                    cancelBtn.onclick = () => {
                        window.location.href = `/customer/appointments/${appointment.id}/cancel`;
                    };
                } else {
                    cancelBtn.style.display = 'none';
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
                modal.show();
            }
        });
    </script>
</body>
</html>