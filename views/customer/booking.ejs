<div class="container" style="padding: 4rem 0;">
    <div class="text-center mb-5">
        <h1 class="mb-2">Book Your Appointment</h1>
        <p class="text-muted" style="max-width: 600px; margin: 0 auto;">
            Choose your service, barber, and preferred time for your grooming session
        </p>
    </div>

    <div class="card" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
        <form id="bookingForm" action="/appointments/book" method="POST">
            <!-- Step 1: Service Selection -->
            <div class="form-step active" id="step1">
                <h3 class="mb-3 flex items-center gap-2">
                    <span class="badge badge-primary rounded-full w-8 h-8 flex items-center justify-center">1</span>
                    Choose Your Service
                </h3>

                <div class="grid gap-3 mb-4">
                    <% if (services && services.length > 0) { %>
                        <% services.forEach(service => { %>
                            <label class="card hover-lift cursor-pointer p-3 border-transparent hover:border-gold transition-all service-option"
                                style="border: 1px solid var(--border-color);">
                                <div class="flex items-center gap-3">
                                    <input type="radio" name="service_id" value="<%= service.id %>" required
                                        data-price="<%= service.price %>" data-duration="<%= service.duration %>"
                                        data-name="<%= service.name %>" class="form-radio text-gold service-radio">
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <h4 class="mb-0 text-lg service-name"><%= service.name %></h4>
                                            <div class="text-gold font-bold text-lg service-price">$<%= service.price %></div>
                                        </div>
                                        <% if (service.description) { %>
                                            <p class="text-muted text-sm mb-1 service-description"><%= service.description %></p>
                                        <% } %>
                                        <div class="flex gap-3 text-xs text-muted">
                                            <span><i class="fas fa-clock mr-1"></i><span class="service-duration"><%= service.duration %></span> mins</span>
                                            <% if (service.category) { %>
                                                <span class="badge badge-neutral text-xs service-category"><%= service.category %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        <% }) %>
                    <% } else { %>
                        <div class="text-center py-4 text-muted">
                            <p>No services available at the moment.</p>
                        </div>
                    <% } %>
                </div>

                <div class="text-right">
                    <button type="button" class="btn btn-primary next-step" data-next="step2">
                        Next: Choose Barber <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Barber Selection -->
            <div class="form-step hidden" id="step2">
                <h3 class="mb-3 flex items-center gap-2">
                    <span class="badge badge-primary rounded-full w-8 h-8 flex items-center justify-center">2</span>
                    Select Your Barber
                </h3>

                <div class="grid grid-2 gap-3 mb-4">
                    <% if (barbers && barbers.length > 0) { %>
                        <% barbers.forEach(barber => { %>
                            <label class="card hover-lift cursor-pointer p-3 border-transparent hover:border-gold transition-all text-center barber-option"
                                style="border: 1px solid var(--border-color);">
                                <input type="radio" name="barber_id" value="<%= barber.id %>" required 
                                       data-name="<%= barber.name %>" class="hidden barber-radio">
                                <div class="avatar-circle mx-auto mb-2"
                                    style="width: 80px; height: 80px; background: var(--bg-tertiary); font-size: 1.5rem; display: flex; align-items: center; justify-content: center;">
                                    <%= barber.name.split(' ').map(n => n[0]).join('') %>
                                </div>
                                <h4 class="mb-1 barber-name"><%= barber.name %></h4>
                                <% if (barber.specialty) { %>
                                    <p class="text-gold text-sm mb-1 barber-specialty"><%= barber.specialty %></p>
                                <% } %>
                                <% if (barber.experience) { %>
                                    <p class="text-muted text-xs barber-experience"><%= barber.experience %> years exp</p>
                                <% } %>
                            </label>
                        <% }) %>
                    <% } else { %>
                        <div class="text-center py-4 text-muted col-span-2">
                            <p>No barbers available at the moment.</p>
                        </div>
                    <% } %>
                </div>
                
                <div class="flex justify-between">
                    <button type="button" class="btn btn-outline prev-step" data-prev="step1">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Services
                    </button>
                    <button type="button" class="btn btn-primary next-step" data-next="step3">
                        Next: Choose Date & Time <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Date & Time Selection -->
            <div class="form-step hidden" id="step3">
                <h3 class="mb-3 flex items-center gap-2">
                    <span class="badge badge-primary rounded-full w-8 h-8 flex items-center justify-center">3</span>
                    Select Date & Time
                </h3>
                
                <div class="grid gap-4 mb-4">
                    <div class="form-group">
                        <label for="appointment_date" class="form-label">Select Date</label>
                        <input type="date" id="appointment_date" name="appointment_date" 
                               class="form-control" required min="<%= new Date().toISOString().split('T')[0] %>">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available Time Slots (9:00 AM - 7:00 PM)</label>
                        <div id="timeSlots" class="grid grid-4 gap-2">
                            <p class="text-muted col-span-4 text-center py-2">Please select a date first to see available time slots</p>
                        </div>
                        <input type="hidden" id="appointment_datetime" name="appointment_datetime" required>
                        <p class="text-xs text-muted mt-2">Appointments can only be booked between 9:00 AM and 7:00 PM</p>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">Additional Notes (Optional)</label>
                        <textarea id="notes" name="notes" class="form-control"
                            placeholder="Any special requests or requirements..." rows="3"></textarea>
                    </div>
                </div>

                <!-- Appointment Summary -->
                <div class="bg-tertiary p-4 rounded mb-4 border border-color">
                    <h4 class="mb-3 border-b border-color pb-2">Appointment Summary</h4>
                    <div class="grid gap-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-muted">Service:</span>
                            <span id="summaryService" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">Barber:</span>
                            <span id="summaryBarber" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">Date & Time:</span>
                            <span id="summaryDateTime" class="font-medium">Not selected</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">Duration:</span>
                            <span id="summaryDuration" class="font-medium">0 mins</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-gold mt-2 pt-2 border-t border-color">
                            <span>Total Price:</span>
                            <span id="summaryTotal">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" class="btn btn-outline prev-step" data-prev="step2">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Barbers
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Confirm Booking <i class="fas fa-check ml-2"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Step navigation logic
    document.querySelectorAll('.next-step').forEach(btn => {
        btn.addEventListener('click', () => {
            const currentStep = btn.closest('.form-step');
            const nextStepId = btn.dataset.next;

            if (validateStep(currentStep)) {
                currentStep.classList.add('hidden');
                document.getElementById(nextStepId).classList.remove('hidden');
                updateSummary();
            }
        });
    });

    document.querySelectorAll('.prev-step').forEach(btn => {
        btn.addEventListener('click', () => {
            const currentStep = btn.closest('.form-step');
            const prevStepId = btn.dataset.prev;
            currentStep.classList.add('hidden');
            document.getElementById(prevStepId).classList.remove('hidden');
        });
    });

    function validateStep(step) {
        const inputs = step.querySelectorAll('input[required]');
        let valid = true;
        
        inputs.forEach(input => {
            if (input.type === 'radio') {
                const radioGroup = step.querySelectorAll(`input[name="${input.name}"]`);
                const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                
                if (!isChecked) {
                    valid = false;
                    const labels = step.querySelectorAll(`.${input.name.includes('service') ? 'service-option' : 'barber-option'}`);
                    labels.forEach(label => {
                        label.style.borderColor = '#dc2626';
                    });
                }
            }
        });

        if (!valid) {
            alert('Please make a selection to continue');
        }

        return valid;
    }

    // Update summary when selections change
    function updateSummary() {
        const serviceInput = document.querySelector('input[name="service_id"]:checked');
        const barberInput = document.querySelector('input[name="barber_id"]:checked');
        const datetimeInput = document.getElementById('appointment_datetime');

        if (serviceInput) {
            document.getElementById('summaryService').textContent = serviceInput.dataset.name;
            document.getElementById('summaryTotal').textContent = '$' + serviceInput.dataset.price;
            document.getElementById('summaryDuration').textContent = serviceInput.dataset.duration + ' mins';
        }

        if (barberInput) {
            document.getElementById('summaryBarber').textContent = barberInput.dataset.name;
        }

        if (datetimeInput.value) {
            const datetime = new Date(datetimeInput.value);
            document.getElementById('summaryDateTime').textContent = datetime.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
    }

    // Add click handlers for service and barber selection
    document.querySelectorAll('.service-option, .barber-option').forEach(option => {
        option.addEventListener('click', (e) => {
            if (!e.target.matches('input')) {
                const radio = option.querySelector('input[type="radio"]');
                radio.checked = true;
                updateSummary();
                
                // Remove error highlighting
                const labels = document.querySelectorAll(`.${option.classList.contains('service-option') ? 'service-option' : 'barber-option'}`);
                labels.forEach(label => {
                    label.style.borderColor = '';
                });
            }
        });
    });

    // Time slot selection
    document.getElementById('appointment_date').addEventListener('change', function() {
        const selectedDate = this.value;
        const slotsContainer = document.getElementById('timeSlots');
        const datetimeInput = document.getElementById('appointment_datetime');
        
        if (!selectedDate) {
            slotsContainer.innerHTML = '<p class="text-muted col-span-4 text-center py-2">Please select a date first</p>';
            datetimeInput.value = '';
            updateSummary();
            return;
        }

        // Check if selected date is in the past
        const today = new Date().toISOString().split('T')[0];
        if (selectedDate < today) {
            slotsContainer.innerHTML = '<p class="text-error col-span-4 text-center py-2">Please select a future date</p>';
            datetimeInput.value = '';
            updateSummary();
            return;
        }

        // Show loading
        slotsContainer.innerHTML = '<p class="text-muted col-span-4 text-center py-2">Loading available time slots...</p>';

        // Generate time slots
        setTimeout(() => {
            generateTimeSlots(selectedDate, slotsContainer);
        }, 300);
    });

    function generateTimeSlots(date, container) {
        // Business hours: 9:00 AM to 7:00 PM (9:00 to 19:00)
        const startHour = 9;
        const endHour = 19;
        const timeSlots = [];
        
        for (let hour = startHour; hour < endHour; hour++) {
            for (let minute = 0; minute < 60; minute += 30) {
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeSlots.push(timeString);
            }
        }

        container.innerHTML = '';
        
        timeSlots.forEach(time => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline btn-sm text-center time-slot';
            btn.textContent = formatTimeForDisplay(time);
            btn.dataset.time = time;
            
            btn.addEventListener('click', function() {
                // Remove active class from all time slots
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('btn-primary');
                    slot.classList.add('btn-outline');
                });
                
                // Add active class to selected time slot
                this.classList.remove('btn-outline');
                this.classList.add('btn-primary');
                
                // Combine date and time into ISO string for backend
                const datetimeValue = `${date}T${time}:00`;
                document.getElementById('appointment_datetime').value = datetimeValue;
                updateSummary();
            });
            
            container.appendChild(btn);
        });
    }

    function formatTimeForDisplay(timeString) {
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
    }

    // Form submission validation
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        const serviceSelected = document.querySelector('input[name="service_id"]:checked');
        const barberSelected = document.querySelector('input[name="barber_id"]:checked');
        const datetimeSelected = document.getElementById('appointment_datetime').value;

        if (!serviceSelected || !barberSelected || !datetimeSelected) {
            e.preventDefault();
            alert('Please complete all required fields before submitting.');
            return;
        }

        // Validate business hours on final submission
        const selectedDatetime = new Date(datetimeSelected);
        const selectedHour = selectedDatetime.getHours();
        
        if (selectedHour < 9 || selectedHour >= 19) {
            e.preventDefault();
            alert('Appointments can only be booked between 9:00 AM and 7:00 PM. Please select a valid time slot.');
            return;
        }

        // Disable submit button to prevent double submission
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Booking... <i class="fas fa-spinner fa-spin ml-2"></i>';
    });

    // Initialize summary
    document.addEventListener('DOMContentLoaded', updateSummary);
</script>

<style>
    .form-step {
        transition: all 0.3s ease;
    }
    
    .hidden {
        display: none;
    }
    
    .service-option:hover,
    .barber-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .time-slot {
        min-width: 90px;
    }
    
    .avatar-circle {
        border-radius: 50%;
        overflow: hidden;
        font-weight: bold;
        color: var(--text-primary);
    }
    
    .text-error {
        color: #dc2626;
    }
</style>