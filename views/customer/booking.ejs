<%- include('../partials/header', { title: 'Book Appointment - Classic Cuts' }) %>

<main class="main-content">
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Book Your Appointment</h1>
            <p class="page-description">
                Choose your service, barber, and preferred time for your grooming session
            </p>
        </div>

        <div class="booking-container">
            <form id="bookingForm" action="/appointments/book" method="POST" class="booking-form">
                <!-- Step 1: Service Selection -->
                <div class="form-step active" id="step1">
                    <h3 class="step-title">1. Choose Your Service</h3>
                    <div class="services-selection">
                        <% if (services && services.length > 0) { %>
                            <% services.forEach(service => { %>
                                <label class="service-option">
                                    <input type="radio" name="service_id" value="<%= service.id %>" required 
                                           data-price="<%= service.price %>" data-duration="<%= service.duration %>">
                                    <div class="option-card">
                                        <div class="option-header">
                                            <h4 class="option-title"><%= service.name %></h4>
                                            <div class="option-price">$<%= service.price %></div>
                                        </div>
                                        <% if (service.description) { %>
                                            <p class="option-description"><%= service.description %></p>
                                        <% } %>
                                        <div class="option-meta">
                                            <span class="duration">‚è±Ô∏è <%= service.duration %> minutes</span>
                                            <% if (service.category) { %>
                                                <span class="category"><%= service.category %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                </label>
                            <% }) %>
                        <% } else { %>
                            <div class="empty-state">
                                <p>No services available at the moment.</p>
                            </div>
                        <% } %>
                    </div>
                    <div class="step-actions">
                        <button type="button" class="btn btn-primary next-step" data-next="step2">
                            Next: Choose Barber
                        </button>
                    </div>
                </div>

                <!-- Step 2: Barber Selection -->
                <div class="form-step" id="step2">
                    <h3 class="step-title">2. Select Your Barber</h3>
                    <div class="barbers-selection">
                        <% if (barbers && barbers.length > 0) { %>
                            <% barbers.forEach(barber => { %>
                                <label class="barber-option">
                                    <input type="radio" name="barber_id" value="<%= barber.id %>" required>
                                    <div class="option-card">
                                        <div class="barber-avatar medium">
                                            <%= barber.name.split(' ').map(n => n[0]).join('') %>
                                        </div>
                                        <div class="barber-details">
                                            <h4 class="barber-name"><%= barber.name %></h4>
                                            <% if (barber.specialization) { %>
                                                <p class="barber-specialty"><%= barber.specialization %></p>
                                            <% } else if (barber.specialty) { %>
                                                <p class="barber-specialty"><%= barber.specialty %></p>
                                            <% } %>
                                            <% if (barber.experience) { %>
                                                <p class="barber-experience"><%= barber.experience %> years experience</p>
                                            <% } %>
                                            <% if (barber.bio) { %>
                                                <p class="barber-bio"><%= barber.bio %></p>
                                            <% } %>
                                        </div>
                                    </div>
                                </label>
                            <% }) %>
                        <% } else { %>
                            <div class="empty-state">
                                <p>No barbers available at the moment.</p>
                            </div>
                        <% } %>
                    </div>
                    <div class="step-actions">
                        <button type="button" class="btn btn-outline prev-step" data-prev="step1">
                            Back
                        </button>
                        <button type="button" class="btn btn-primary next-step" data-next="step3">
                            Next: Choose Date & Time
                        </button>
                    </div>
                </div>

                <!-- Step 3: Date & Time Selection -->
                <div class="form-step" id="step3">
                    <h3 class="step-title">3. Select Date & Time</h3>
                    <div class="datetime-selection">
                        <div class="form-group">
                            <label for="appointment_date" class="form-label">Select Date</label>
                            <input type="date" id="appointment_date" name="appointment_date" 
                                   class="form-control" required 
                                   min="<%= new Date().toISOString().split('T')[0] %>"
                                   max="<%= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] %>">
                            <small class="form-text">You can book appointments up to 30 days in advance</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Available Time Slots</label>
                            <div id="timeSlots" class="time-slots">
                                <div class="time-slots-placeholder">
                                    <p class="help-text">üìÖ Please select a date first to see available time slots</p>
                                </div>
                            </div>
                            <div id="loadingSlots" class="loading-slots" style="display: none;">
                                <p class="help-text">Loading available time slots...</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes" class="form-label">Additional Notes (Optional)</label>
                            <textarea id="notes" name="notes" class="form-control" 
                                      placeholder="Any special requests or requirements..." 
                                      rows="3" maxlength="500"></textarea>
                            <small class="form-text">Maximum 500 characters</small>
                        </div>
                    </div>
                    
                    <!-- Appointment Summary -->
                    <div class="appointment-summary" id="appointmentSummary">
                        <h4>Appointment Summary</h4>
                        <div class="summary-details">
                            <div class="summary-item">
                                <span class="label">Service:</span>
                                <span id="summaryService" class="summary-value">Not selected</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Barber:</span>
                                <span id="summaryBarber" class="summary-value">Not selected</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Date & Time:</span>
                                <span id="summaryDateTime" class="summary-value">Not selected</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Duration:</span>
                                <span id="summaryDuration" class="summary-value">-</span>
                            </div>
                            <div class="summary-item total">
                                <span class="label">Total Price:</span>
                                <span id="summaryTotal" class="summary-value">$0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-actions">
                        <button type="button" class="btn btn-outline prev-step" data-prev="step2">
                            Back
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitButton" disabled>
                            Confirm Booking
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Multi-step form navigation
    const steps = document.querySelectorAll('.form-step');
    const nextButtons = document.querySelectorAll('.next-step');
    const prevButtons = document.querySelectorAll('.prev-step');
    
    // Form elements
    const serviceInputs = document.querySelectorAll('input[name="service_id"]');
    const barberInputs = document.querySelectorAll('input[name="barber_id"]');
    const dateInput = document.getElementById('appointment_date');
    const timeSlotsContainer = document.getElementById('timeSlots');
    const loadingSlots = document.getElementById('loadingSlots');
    const submitButton = document.getElementById('submitButton');
    
    // Summary elements
    const summaryService = document.getElementById('summaryService');
    const summaryBarber = document.getElementById('summaryBarber');
    const summaryDateTime = document.getElementById('summaryDateTime');
    const summaryDuration = document.getElementById('summaryDuration');
    const summaryTotal = document.getElementById('summaryTotal');
    
    let selectedService = null;
    let selectedBarber = null;
    let selectedDate = null;
    let selectedTime = null;
    
    // Step navigation
    nextButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentStep = this.closest('.form-step');
            const nextStepId = this.getAttribute('data-next');
            const nextStep = document.getElementById(nextStepId);
            
            if (validateStep(currentStep)) {
                currentStep.classList.remove('active');
                nextStep.classList.add('active');
                updateSummary();
            }
        });
    });
    
    prevButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentStep = this.closest('.form-step');
            const prevStepId = this.getAttribute('data-prev');
            const prevStep = document.getElementById(prevStepId);
            
            currentStep.classList.remove('active');
            prevStep.classList.add('active');
        });
    });
    
    // Service selection
    serviceInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.checked) {
                selectedService = {
                    id: this.value,
                    name: this.closest('.service-option').querySelector('.option-title').textContent,
                    price: parseFloat(this.getAttribute('data-price')),
                    duration: parseInt(this.getAttribute('data-duration'))
                };
                updateSummary();
            }
        });
    });
    
    // Barber selection
    barberInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.checked) {
                selectedBarber = {
                    id: this.value,
                    name: this.closest('.barber-option').querySelector('.barber-name').textContent
                };
                updateSummary();
            }
        });
    });
    
    // Date selection and time slot loading
    dateInput.addEventListener('change', function() {
        selectedDate = this.value;
        selectedTime = null;
        
        if (selectedDate && selectedService && selectedBarber) {
            loadTimeSlots(selectedDate, selectedService.id, selectedBarber.id);
        }
        
        updateSummary();
    });
    
    // Validate step before proceeding
    function validateStep(step) {
        const requiredInputs = step.querySelectorAll('input[required]');
        let isValid = true;
        
        requiredInputs.forEach(input => {
            if (!input.checked && input.type === 'radio') {
                isValid = false;
                input.closest('.option-card').classList.add('error');
            } else {
                input.closest('.option-card')?.classList.remove('error');
            }
        });
        
        if (!isValid) {
            alert('Please make a selection before proceeding.');
        }
        
        return isValid;
    }
    
    // Load available time slots
    function loadTimeSlots(date, serviceId, barberId) {
        timeSlotsContainer.innerHTML = '';
        loadingSlots.style.display = 'block';
        
        fetch(`/appointments/available-slots?date=${date}&serviceId=${serviceId}&barberId=${barberId}`)
            .then(response => response.json())
            .then(data => {
                loadingSlots.style.display = 'none';
                
                if (data.success && data.slots && data.slots.length > 0) {
                    timeSlotsContainer.innerHTML = '';
                    data.slots.forEach(slot => {
                        const timeButton = document.createElement('button');
                        timeButton.type = 'button';
                        timeButton.className = 'time-slot';
                        timeButton.textContent = slot.time;
                        timeButton.dataset.time = slot.time;
                        
                        timeButton.addEventListener('click', function() {
                            // Remove selected class from all buttons
                            document.querySelectorAll('.time-slot').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            
                            // Add selected class to clicked button
                            this.classList.add('selected');
                            selectedTime = this.dataset.time;
                            updateSummary();
                            
                            // Enable submit button
                            submitButton.disabled = false;
                        });
                        
                        timeSlotsContainer.appendChild(timeButton);
                    });
                } else {
                    timeSlotsContainer.innerHTML = `
                        <div class="empty-time-slots">
                            <p>‚ùå No available time slots for this date.</p>
                            <p class="help-text">Please try another date or contact us for assistance.</p>
                        </div>
                    `;
                    submitButton.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading time slots:', error);
                loadingSlots.style.display = 'none';
                timeSlotsContainer.innerHTML = `
                    <div class="error-time-slots">
                        <p>‚ö†Ô∏è Error loading time slots. Please try again.</p>
                    </div>
                `;
                submitButton.disabled = true;
            });
    }
    
    // Update appointment summary
    function updateSummary() {
        // Update service
        if (selectedService) {
            summaryService.textContent = selectedService.name;
            summaryDuration.textContent = `${selectedService.duration} minutes`;
            summaryTotal.textContent = `$${selectedService.price.toFixed(2)}`;
        } else {
            summaryService.textContent = 'Not selected';
            summaryDuration.textContent = '-';
            summaryTotal.textContent = '$0.00';
        }
        
        // Update barber
        if (selectedBarber) {
            summaryBarber.textContent = selectedBarber.name;
        } else {
            summaryBarber.textContent = 'Not selected';
        }
        
        // Update date and time
        if (selectedDate && selectedTime) {
            const dateObj = new Date(selectedDate + 'T' + selectedTime);
            summaryDateTime.textContent = dateObj.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } else if (selectedDate) {
            summaryDateTime.textContent = `${selectedDate} (Time not selected)`;
        } else {
            summaryDateTime.textContent = 'Not selected';
        }
        
        // Update submit button state
        submitButton.disabled = !(selectedService && selectedBarber && selectedDate && selectedTime);
    }
    
    // Form submission
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        if (!selectedService || !selectedBarber || !selectedDate || !selectedTime) {
            e.preventDefault();
            alert('Please complete all steps before booking.');
            return;
        }
        
        // Add loading state to submit button
        submitButton.disabled = true;
        submitButton.innerHTML = 'Booking... <i class="spinner"></i>';
    });
    
    // Initialize summary
    updateSummary();
});
</script>

<style>
.booking-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.services-selection,
.barbers-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.service-option,
.barber-option {
    cursor: pointer;
}

.service-option input,
.barber-option input {
    display: none;
}

.option-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    background: white;
}

.service-option input:checked + .option-card,
.barber-option input:checked + .option-card {
    border-color: #007bff;
    background-color: #f8f9fa;
    box-shadow: 0 2px 10px rgba(0, 123, 255, 0.2);
}

.option-card.error {
    border-color: #dc3545;
}

.option-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.option-title {
    margin: 0;
    flex: 1;
}

.option-price {
    font-size: 1.25rem;
    font-weight: bold;
    color: #28a745;
}

.option-description {
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.option-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.barber-option .option-card {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.barber-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.barber-details {
    flex: 1;
}

.barber-name {
    margin: 0 0 0.25rem 0;
}

.barber-specialty {
    color: #007bff;
    margin: 0 0 0.25rem 0;
    font-weight: 500;
}

.barber-experience,
.barber-bio {
    color: #6c757d;
    margin: 0;
    font-size: 0.875rem;
}

.time-slots {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.time-slot {
    padding: 0.75rem 0.5rem;
    border: 2px solid #e9ecef;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.time-slot:hover {
    border-color: #007bff;
}

.time-slot.selected {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.appointment-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.summary-details {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
}

.summary-item.total {
    border-top: 1px solid #dee2e6;
    padding-top: 0.75rem;
    margin-top: 0.5rem;
    font-weight: bold;
    font-size: 1.1rem;
}

.step-actions {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    margin-top: 2rem;
}

.empty-state,
.time-slots-placeholder,
.empty-time-slots,
.error-time-slots {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.loading-slots {
    text-align: center;
    padding: 1rem;
}

.help-text {
    color: #6c757d;
    font-size: 0.875rem;
    margin: 0.25rem 0 0 0;
}

@media (max-width: 768px) {
    .services-selection,
    .barbers-selection {
        grid-template-columns: 1fr;
    }
    
    .step-actions {
        flex-direction: column;
    }
    
    .barber-option .option-card {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<%- include('../partials/footer') %>